<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>üîî WebSocket Events Test - All Notification Operations</title>
        <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
        <style>
            * {
                box-sizing: border-box;
                margin: 0;
                padding: 0;
            }
            body {
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                padding: 20px;
                min-height: 100vh;
            }
            .container {
                max-width: 1400px;
                margin: 0 auto;
                background: white;
                border-radius: 15px;
                padding: 30px;
                box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            }
            h1 {
                color: #667eea;
                margin-bottom: 10px;
            }
            h2 {
                color: #764ba2;
                margin: 20px 0 10px;
                border-bottom: 2px solid #667eea;
                padding-bottom: 5px;
            }
            .grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 20px;
            }
            .panel {
                background: #f8f9fa;
                padding: 20px;
                border-radius: 10px;
                border: 2px solid #ddd;
            }
            .status {
                padding: 15px;
                border-radius: 8px;
                margin: 15px 0;
                font-weight: bold;
                text-align: center;
            }
            .status.connected {
                background: #d4edda;
                color: #155724;
                border: 2px solid #c3e6cb;
            }
            .status.disconnected {
                background: #f8d7da;
                color: #721c24;
                border: 2px solid #f5c6cb;
            }
            input,
            button {
                width: 100%;
                padding: 12px;
                margin: 8px 0;
                border: 2px solid #ddd;
                border-radius: 6px;
                font-size: 14px;
            }
            button {
                background: #667eea;
                color: white;
                border: none;
                cursor: pointer;
                font-weight: bold;
                transition: all 0.3s;
            }
            button:hover {
                background: #764ba2;
                transform: translateY(-2px);
            }
            button:disabled {
                background: #ccc;
                cursor: not-allowed;
                transform: none;
            }
            button.success {
                background: #28a745;
            }
            button.danger {
                background: #dc3545;
            }
            .event-log {
                background: #1e1e1e;
                color: #d4d4d4;
                padding: 15px;
                border-radius: 8px;
                font-family: 'Courier New', monospace;
                font-size: 13px;
                max-height: 400px;
                overflow-y: auto;
                margin-top: 15px;
            }
            .event {
                padding: 8px;
                margin: 5px 0;
                border-left: 4px solid;
                padding-left: 10px;
            }
            .event.create {
                border-color: #4caf50;
                background: rgba(76, 175, 80, 0.1);
            }
            .event.read {
                border-color: #2196f3;
                background: rgba(33, 150, 243, 0.1);
            }
            .event.delete {
                border-color: #f44336;
                background: rgba(244, 67, 54, 0.1);
            }
            .event.error {
                border-color: #ff9800;
                background: rgba(255, 152, 0, 0.1);
            }
            .timestamp {
                color: #888;
                font-size: 11px;
            }
            .badge {
                display: inline-block;
                padding: 4px 10px;
                border-radius: 15px;
                font-size: 12px;
                font-weight: bold;
                margin-left: 10px;
            }
            .badge.green {
                background: #28a745;
                color: white;
            }
            .badge.blue {
                background: #007bff;
                color: white;
            }
            .badge.red {
                background: #dc3545;
                color: white;
            }
            .channels {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                gap: 10px;
                margin: 15px 0;
            }
            .channel {
                padding: 10px;
                background: white;
                border: 2px solid #ddd;
                border-radius: 8px;
                text-align: center;
            }
            .channel.active {
                border-color: #28a745;
                background: #d4edda;
            }
            .channel-name {
                font-weight: bold;
                color: #667eea;
                margin-bottom: 5px;
            }
            .channel-count {
                font-size: 24px;
                color: #333;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>üîî WebSocket Events Test - Complete Notification System</h1>
            <p><strong>Test T·∫§T C·∫¢ WebSocket events:</strong> Create, Read, Read All, Delete, Batch Delete</p>

            <div id="status" class="status disconnected">‚ùå Disconnected</div>

            <h2>üîå Connection</h2>
            <input type="password" id="token" placeholder="Paste JWT token here..." />
            <button id="connectBtn" onclick="connect()">Connect WebSocket</button>
            <button id="disconnectBtn" onclick="disconnect()" disabled>Disconnect</button>

            <h2>üì° Subscribed Channels</h2>
            <div class="channels">
                <div class="channel" id="channel-new">
                    <div class="channel-name">/user/queue/notifications</div>
                    <div class="channel-count" id="count-new">0</div>
                    <small>New Notifications</small>
                </div>
                <div class="channel" id="channel-read">
                    <div class="channel-name">/queue/notifications/read</div>
                    <div class="channel-count" id="count-read">0</div>
                    <small>Mark as Read</small>
                </div>
                <div class="channel" id="channel-read-all">
                    <div class="channel-name">/queue/notifications/read-all</div>
                    <div class="channel-count" id="count-read-all">0</div>
                    <small>Mark All Read</small>
                </div>
                <div class="channel" id="channel-deleted">
                    <div class="channel-name">/queue/notifications/deleted</div>
                    <div class="channel-count" id="count-deleted">0</div>
                    <small>Deleted</small>
                </div>
                <div class="channel" id="channel-batch-deleted">
                    <div class="channel-name">/queue/notifications/batch-deleted</div>
                    <div class="channel-count" id="count-batch-deleted">0</div>
                    <small>Batch Deleted</small>
                </div>
            </div>

            <div class="grid">
                <div class="panel">
                    <h2>üì¨ Test Actions</h2>
                    <p><small>Use cURL commands to trigger events:</small></p>

                    <h3>1Ô∏è‚É£ Create Notification</h3>
                    <button class="success" onclick="copyCommand('create')">üìã Copy cURL Command</button>
                    <pre
                        style="
                            background: #f0f0f0;
                            padding: 10px;
                            border-radius: 5px;
                            font-size: 11px;
                            overflow-x: auto;
                            margin-top: 10px;
                        "
                    >
curl -X POST http://localhost:8080/api/v1/admin/notifications \
  -H "Authorization: Bearer ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "userId": "USER_UUID",
    "title": "üî• Test",
    "content": "WebSocket test",
    "type": "system_alert"
  }'</pre
                    >

                    <h3>2Ô∏è‚É£ Mark as Read</h3>
                    <button class="success" onclick="copyCommand('read')">üìã Copy cURL Command</button>
                    <pre
                        style="
                            background: #f0f0f0;
                            padding: 10px;
                            border-radius: 5px;
                            font-size: 11px;
                            overflow-x: auto;
                            margin-top: 10px;
                        "
                    >
curl -X PUT http://localhost:8080/api/v1/notifications/123/read \
  -H "Authorization: Bearer USER_TOKEN"</pre
                    >

                    <h3>3Ô∏è‚É£ Mark All Read</h3>
                    <button class="success" onclick="copyCommand('read-all')">üìã Copy cURL Command</button>
                    <pre
                        style="
                            background: #f0f0f0;
                            padding: 10px;
                            border-radius: 5px;
                            font-size: 11px;
                            overflow-x: auto;
                            margin-top: 10px;
                        "
                    >
curl -X PUT http://localhost:8080/api/v1/notifications/read-all \
  -H "Authorization: Bearer USER_TOKEN"</pre
                    >

                    <h3>4Ô∏è‚É£ Delete Notification</h3>
                    <button class="danger" onclick="copyCommand('delete')">üìã Copy cURL Command</button>
                    <pre
                        style="
                            background: #f0f0f0;
                            padding: 10px;
                            border-radius: 5px;
                            font-size: 11px;
                            overflow-x: auto;
                            margin-top: 10px;
                        "
                    >
curl -X DELETE http://localhost:8080/api/v1/notifications/123 \
  -H "Authorization: Bearer USER_TOKEN"</pre
                    >

                    <h3>5Ô∏è‚É£ Batch Delete</h3>
                    <button class="danger" onclick="copyCommand('batch-delete')">üìã Copy cURL Command</button>
                    <pre
                        style="
                            background: #f0f0f0;
                            padding: 10px;
                            border-radius: 5px;
                            font-size: 11px;
                            overflow-x: auto;
                            margin-top: 10px;
                        "
                    >
curl -X DELETE "http://localhost:8080/api/v1/notifications?ids=123,456,789" \
  -H "Authorization: Bearer USER_TOKEN"</pre
                    >
                </div>

                <div class="panel">
                    <h2>üìã Event Log</h2>
                    <button onclick="clearLog()" style="width: auto; padding: 8px 15px">üóëÔ∏è Clear Log</button>
                    <div class="event-log" id="eventLog"></div>
                </div>
            </div>
        </div>

        <script>
            let stompClient = null;
            let counts = {
                new: 0,
                read: 0,
                readAll: 0,
                deleted: 0,
                batchDeleted: 0,
            };

            function log(message, type = 'info', channel = null) {
                const logDiv = document.getElementById('eventLog');
                const timestamp = new Date().toLocaleTimeString();
                const event = document.createElement('div');
                event.className = `event ${type}`;

                let badge = '';
                if (channel) {
                    counts[channel]++;
                    document.getElementById(`count-${channel}`).textContent = counts[channel];
                    document.getElementById(`channel-${channel}`).classList.add('active');
                    setTimeout(() => {
                        document.getElementById(`channel-${channel}`).classList.remove('active');
                    }, 1000);
                }

                event.innerHTML = `
                <div>
                    <span class="timestamp">[${timestamp}]</span> ${message}
                </div>
            `;
                logDiv.insertBefore(event, logDiv.firstChild);
            }

            function updateStatus(connected) {
                const statusDiv = document.getElementById('status');
                statusDiv.className = `status ${connected ? 'connected' : 'disconnected'}`;
                statusDiv.textContent = connected ? '‚úÖ Connected - All channels subscribed' : '‚ùå Disconnected';

                document.getElementById('connectBtn').disabled = connected;
                document.getElementById('disconnectBtn').disabled = !connected;
            }

            function connect() {
                const token = document.getElementById('token').value.trim();
                if (!token) {
                    alert('Please enter JWT token!');
                    return;
                }

                log('üîå Connecting to WebSocket...', 'info');

                const socket = new SockJS('http://localhost:8080/ws');
                stompClient = Stomp.over(socket);
                stompClient.debug = null;

                stompClient.connect(
                    { Authorization: `Bearer ${token}` },
                    function (frame) {
                        updateStatus(true);
                        log('‚úÖ WebSocket connected successfully!', 'create');

                        // 1. New notifications
                        stompClient.subscribe('/user/queue/notifications', function (message) {
                            const notification = JSON.parse(message.body);
                            log(
                                `üì¨ NEW NOTIFICATION: "${notification.title}" - ${notification.content}`,
                                'create',
                                'new',
                            );

                            // Browser notification
                            if (Notification.permission === 'granted') {
                                new Notification(notification.title, {
                                    body: notification.content,
                                    icon: 'üîî',
                                });
                            }
                        });
                        log('‚úÖ Subscribed: /user/queue/notifications', 'create');

                        // 2. Mark as read
                        stompClient.subscribe('/user/queue/notifications/read', function (message) {
                            const notificationId = JSON.parse(message.body);
                            log(`‚úîÔ∏è MARK AS READ: Notification #${notificationId}`, 'read', 'read');
                        });
                        log('‚úÖ Subscribed: /user/queue/notifications/read', 'read');

                        // 3. Mark all as read
                        stompClient.subscribe('/user/queue/notifications/read-all', function (message) {
                            const count = JSON.parse(message.body);
                            log(`‚úîÔ∏è‚úîÔ∏è MARK ALL AS READ: ${count} notifications marked as read`, 'read', 'readAll');
                        });
                        log('‚úÖ Subscribed: /user/queue/notifications/read-all', 'read');

                        // 4. Delete notification
                        stompClient.subscribe('/user/queue/notifications/deleted', function (message) {
                            const notificationId = JSON.parse(message.body);
                            log(`üóëÔ∏è DELETED: Notification #${notificationId}`, 'delete', 'deleted');
                        });
                        log('‚úÖ Subscribed: /user/queue/notifications/deleted', 'delete');

                        // 5. Batch delete
                        stompClient.subscribe('/user/queue/notifications/batch-deleted', function (message) {
                            const deletedIds = JSON.parse(message.body);
                            log(
                                `üóëÔ∏èüóëÔ∏è BATCH DELETED: ${deletedIds.length} notifications [${deletedIds.join(', ')}]`,
                                'delete',
                                'batchDeleted',
                            );
                        });
                        log('‚úÖ Subscribed: /user/queue/notifications/batch-deleted', 'delete');

                        // Request browser notification permission
                        if (Notification.permission === 'default') {
                            Notification.requestPermission();
                        }
                    },
                    function (error) {
                        updateStatus(false);
                        log(`‚ùå Connection failed: ${error}`, 'error');
                    },
                );
            }

            function disconnect() {
                if (stompClient) {
                    stompClient.disconnect();
                    updateStatus(false);
                    log('üîå Disconnected from WebSocket', 'info');
                }
            }

            function clearLog() {
                document.getElementById('eventLog').innerHTML = '';
                counts = { new: 0, read: 0, readAll: 0, deleted: 0, batchDeleted: 0 };
                ['new', 'read', 'read-all', 'deleted', 'batch-deleted'].forEach((ch) => {
                    document.getElementById(`count-${ch}`).textContent = '0';
                });
                log('üóëÔ∏è Event log cleared', 'info');
            }

            function copyCommand(type) {
                const commands = {
                    create: 'curl -X POST http://localhost:8080/api/v1/admin/notifications -H "Authorization: Bearer ADMIN_TOKEN" -H "Content-Type: application/json" -d \'{"userId":"USER_UUID","title":"üî• Test","content":"WebSocket test","type":"system_alert"}\'',
                    read: 'curl -X PUT http://localhost:8080/api/v1/notifications/123/read -H "Authorization: Bearer USER_TOKEN"',
                    'read-all':
                        'curl -X PUT http://localhost:8080/api/v1/notifications/read-all -H "Authorization: Bearer USER_TOKEN"',
                    delete: 'curl -X DELETE http://localhost:8080/api/v1/notifications/123 -H "Authorization: Bearer USER_TOKEN"',
                    'batch-delete':
                        'curl -X DELETE "http://localhost:8080/api/v1/notifications?ids=123,456,789" -H "Authorization: Bearer USER_TOKEN"',
                };

                navigator.clipboard.writeText(commands[type]);
                log(`üìã Copied ${type} command to clipboard!`, 'info');
            }

            // Auto-load token from localStorage
            window.onload = function () {
                const savedToken = localStorage.getItem('jwt_token');
                if (savedToken) {
                    document.getElementById('token').value = savedToken;
                }
                log('üöÄ WebSocket Events Test Ready!', 'info');
            };

            // Save token to localStorage
            document.getElementById('token').addEventListener('input', function (e) {
                localStorage.setItem('jwt_token', e.target.value);
            });

            // Cleanup
            window.onbeforeunload = function () {
                disconnect();
            };
        </script>
    </body>
</html>
