# Core Feature Test-Care

| ID    | Scenario                                   | Preconditions                                                | Steps                                                                                                     | Expected Result                                                                                                 | Test Type            |
| ----- | ------------------------------------------ | ------------------------------------------------------------ | --------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------- | -------------------- |
| CF-01 | Đăng nhập thành công                       | Tài khoản learner hợp lệ tồn tại, backend đang chạy          | Gọi `POST /api/v1/auth/signin` với email/password đúng.                                                   | HTTP 200, trả về `data.accessToken`, `data.refreshToken`, `tokenType=Bearer`. Redis rate-limit không kích hoạt. | API (Integration)    |
| CF-02 | Đăng nhập sai thông tin                    | Giống CF-01                                                  | Gọi `POST /api/v1/auth/signin` với mật khẩu sai.                                                          | HTTP 4xx với mã lỗi business, message "Email hoặc mật khẩu không đúng" (hoặc tương đương).                      | API (Negative)       |
| CF-03 | Đăng xuất và xác nhận token bị thu hồi     | User đang đăng nhập, có access token hợp lệ                  | Gọi `POST /api/v1/auth/signout`, sau đó dùng lại token cũ để gọi `/api/v1/learn-vocabs/vocabs`.           | Logout trả 200; request thứ 2 bị 401/403 hoặc báo token invalid.                                                | API (Integration)    |
| CF-04 | Lấy danh sách từ để học (tất cả topics)    | User có ít nhất 1 topic đã gán từ                            | `GET /api/v1/learn-vocabs/vocabs?page=1&size=20`.                                                         | 200 với `data` chứa các vocab status NEW/UNKNOWN, `meta` đầy đủ phân trang.                                     | API (Integration)    |
| CF-05 | Gửi kết quả học từ vựng                    | Có `vocabId` từ CF-04                                        | `POST /api/v1/learn-vocabs/submit` với `vocabId`, `isCorrect`, `quality`.                                 | 200, trả về `status` cập nhật (KNOWN/UNKNOWN), `timesCorrect/timesWrong` tăng đúng.                             | Service/API          |
| CF-06 | Bắt đầu Quick Quiz                         | User có JWT hợp lệ, dữ liệu vocab đủ                         | `POST /api/v1/games/quick-quiz/start` với `totalQuestions`, `timePerQuestion`, `cefr`.                    | 201 với `sessionId`, `currentQuestion`, `totalQuestions` theo request.                                          | API (Integration)    |
| CF-07 | Trả lời & hoàn thành Quick Quiz            | Session từ CF-06                                             | Lặp `POST /api/v1/games/quick-quiz/answer` / `skip` cho đến hết câu, sau đó `GET /session/{sessionId}`.   | Điểm số, streak, accuracy cập nhật; session có `status=COMPLETED`, `results` đầy đủ.                            | API (Integration)    |
| CF-08 | Bắt đầu Image-Word Matching                | User có CEFR hợp lệ hoặc default                             | `POST /api/v1/games/image-word-matching/start` (hoặc `/start-auto`).                                      | 200 với `sessionId`, `totalPairs`, danh sách vocab kèm img/audio.                                               | API (Integration)    |
| CF-09 | Nộp kết quả Image-Word Matching            | Session từ CF-08                                             | `POST /api/v1/games/image-word-matching/submit` với `matchedVocabIds`, `timeTaken`, `wrongAttempts`.      | `score = cefrScore + timeBonus - wrongPenalty`, `correctMatches == totalPairs`, `status=COMPLETED`.             | API (Integration)    |
| CF-10 | Bắt đầu Word-Definition Matching           | User có CEFR hoặc default                                    | `POST /api/v1/games/word-definition-matching/start`.                                                      | 200 với danh sách word + meaning, `sessionId`, `totalPairs`.                                                    | API (Integration)    |
| CF-11 | Nộp kết quả Word-Definition Matching       | Session từ CF-10                                             | `POST /api/v1/games/word-definition-matching/submit` với `matchedVocabIds`, `timeTaken`, `wrongAttempts`. | Cách tính điểm giống Image-Word; `accuracy` phản ánh tỉ lệ ghép đúng; session chuyển COMPLETED.                 | API (Integration)    |
| CF-12 | Đồng bộ offline – tải topics               | User có dữ liệu học (user_vocab_progress)                    | `GET /api/v1/offline/topics`.                                                                             | 200, mỗi topic có `progressPercent`; số lượng từ khớp với DB.                                                   | API (Integration)    |
| CF-13 | Đồng bộ offline – tải vocab của topic      | Có `topicId` từ CF-12                                        | `GET /api/v1/offline/topics/{topicId}/vocabs`.                                                            | Trả về vocab + tiến độ (status, nextReview).                                                                    | API (Integration)    |
| CF-14 | Đồng bộ offline – batch upload             | Chuẩn bị payload `BatchSyncRequest` với session/vocab hợp lệ | `POST /api/v1/offline/sync/batch` với danh sách session, detail, vocab progress.                          | Response ghi `syncedGameSessions`, `syncedGameSessionDetails`, `syncedVocabProgress`; `errors` rỗng.            | Service/API          |
| CF-15 | Đồng bộ offline – complete sync idempotent | Có payload như CF-14                                         | Gọi `POST /api/v1/offline/sync/complete` 2 lần liên tiếp.                                                 | Lần 1 đồng bộ thành công; lần 2 bỏ qua bản ghi trùng, không tạo bản ghi lỗi (đảm bảo idempotent).               | Service/API (Repeat) |

> Các steps có thể thực thi trực tiếp bằng file `tests/core_feature_tests.http`. Cần cập nhật biến môi trường (`@userEmail`, `@topicName`, UUID vocab) trước khi chạy.
