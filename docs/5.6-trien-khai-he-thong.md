# 5.6. Triển khai hệ thống

## 5.6.1. Tổng quan triển khai

Hệ thống Card Words được triển khai trên VPS (Virtual Private Server) sử dụng công nghệ Docker containerization để đảm bảo tính nhất quán, dễ dàng quản lý và khả năng mở rộng. Kiến trúc triển khai bao gồm 4 containers chính chạy độc lập và giao tiếp với nhau thông qua Docker network.

### Thông tin VPS

-   **Nhà cung cấp**: VinaHost
-   **Hệ điều hành**: Ubuntu 24.04 LTS (64-bit)
-   **Cấu hình phần cứng**:
    -   CPU: 3 vCores
    -   RAM: 3 GB
    -   Storage: 60 GB SSD
    -   Bandwidth: 100 Mbps
-   **IP Address**: 103.9.77.220

### Kiến trúc triển khai

```
┌─────────────────────────────────────────────────────────────┐
│                         VPS Server                          │
│                    Ubuntu 24.04 LTS                         │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐    │
│  │ PostgreSQL   │  │    Redis     │  │  Spring Boot │    │
│  │  Container   │  │  Container   │  │     API      │    │
│  │   Port 5432  │  │   Port 6379  │  │   Port 8080  │    │
│  └──────────────┘  └──────────────┘  └──────────────┘    │
│                                                             │
│  ┌──────────────┐                                          │
│  │  Python AI   │                                          │
│  │   Service    │                                          │
│  │   Port 8001  │                                          │
│  └──────────────┘                                          │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐  │
│  │         Docker Network: card-words-network          │  │
│  └─────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

## 5.6.2. Chuẩn bị môi trường triển khai

### Bước 1: Cài đặt Docker Engine

Docker là nền tảng containerization được sử dụng để đóng gói và chạy các services của hệ thống.

```bash
# Cập nhật package index
apt update && apt upgrade -y

# Cài đặt Docker bằng convenience script
curl -fsSL https://get.docker.com | sh

# Cài đặt Docker Compose plugin
apt install docker-compose-plugin -y

# Kiểm tra phiên bản
docker --version
# Output: Docker version 29.1.1, build 0aedba5

docker compose version
# Output: Docker Compose version v2.40.3
```

### Bước 2: Cài đặt công cụ build

Do VPS có RAM hạn chế (3GB), việc build Spring Boot application trong Docker container có thể gây quá tải. Giải pháp là build JAR file trực tiếp trên VPS trước khi đóng gói vào Docker image.

```bash
# Cài đặt Java Development Kit 17
apt install openjdk-17-jdk -y

# Cài đặt Apache Maven
apt install maven -y

# Cài đặt Git
apt install git -y
```

### Bước 3: Cấu hình Java version

Maven mặc định sử dụng Java 21, nhưng project yêu cầu Java 17. Cần chuyển đổi Java version:

```bash
# Liệt kê các phiên bản Java có sẵn
update-alternatives --config java

# Chọn Java 17 (option 1)
# Selection: 1

# Xác nhận phiên bản
java -version
# Output: openjdk version "17.0.17"
```

## 5.6.3. Clone source code và cấu hình

### Bước 1: Clone repository

```bash
# Di chuyển đến thư mục /opt
cd /opt

# Clone project từ GitHub
git clone https://github.com/thuanthichlaptrinh/card-words-services.git

# Di chuyển vào thư mục project
cd card-words-services
```

### Bước 2: Tạo file cấu hình môi trường

File `.env` chứa các biến môi trường cho tất cả services trong hệ thống:

```bash
# Copy template từ file production
cp .env.production .env

# Chỉnh sửa file .env
nano .env
```

Nội dung file `.env` quan trọng:

```env
# Database Configuration
POSTGRES_USER=postgres
POSTGRES_PASSWORD=123456
POSTGRES_DB=card_words
POSTGRES_HOST=postgres
POSTGRES_PORT=5432

# Redis Configuration
REDIS_HOST=redis
REDIS_PORT=6379
REDIS_DB=0
REDIS_AI_DB=1

# JWT Authentication
JWT_SECRET=Y2FyZC13b3Jkcy1zZWNyZXQta2V5LWZvci1qd3QtdG9rZW4tZ2VuZXJhdGlvbg==
JWT_EXPIRATION_TIME=86400000

# Spring Boot API
SERVER_SPRING_PORT=8080

# AI Service
SERVER_FLASH_PORT=8001
ACTIVE_MODEL_TYPE=random_forest
AI_SERVICE_URL=http://card-words-ai:8001

# Email Configuration
MAIL_HOST=smtp.gmail.com
MAIL_PORT=587
MAIL_USERNAME=cardwordsgame@gmail.com
MAIL_PASSWORD=puvejqnsiprvdnxa

# Google OAuth2
GOOGLE_OAUTH_CLIENT_ID=157814544933-v1gn4l8k6jkvn20j45ps885s28slsg66.apps.googleusercontent.com
GOOGLE_OAUTH_CLIENT_SECRET=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
GOOGLE_OAUTH_REDIRECT_URI=http://103.9.77.220:8080/api/v1/auth/google/callback

# Firebase Storage
FIREBASE_STORAGE_BUCKET=card-b1260.firebasestorage.app

# Gemini AI
GEMINI_API_KEY=
```

### Bước 3: Cấu hình Firebase Service Account

File `firebase-service-account.json` chứa credentials để kết nối với Firebase Storage:

```bash
# Tạo file Firebase credentials
nano /opt/card-words-services/card-words/src/main/resources/firebase-service-account.json

# Paste nội dung JSON từ Firebase Console
# Lưu file: Ctrl+X -> Y -> Enter
```

### Bước 4: Tắt Flyway Migration

Do database đã có sẵn dữ liệu và migration scripts có thể gây lỗi, cần tắt Flyway:

```yaml
# File: card-words/src/main/resources/application.yml
spring:
    flyway:
        enabled: false # Thay đổi từ true sang false
```

## 5.6.4. Build ứng dụng

### Bước 1: Build Spring Boot JAR file

```bash
# Di chuyển vào thư mục Spring Boot
cd /opt/card-words-services/card-words

# Build JAR file (bỏ qua tests để tăng tốc độ)
mvn clean package -DskipTests

# Quá trình build mất khoảng 3-5 phút
# Output: BUILD SUCCESS
# JAR file được tạo tại: target/card-words-0.0.1-SNAPSHOT.jar
```

### Bước 2: Cấu hình Dockerfile tối ưu

Do đã build JAR file sẵn, Dockerfile chỉ cần copy JAR vào image thay vì build lại:

```dockerfile
# File: card-words/Dockerfile
FROM eclipse-temurin:17-jre-alpine

WORKDIR /app

# Copy JAR đã build sẵn
COPY card-words/target/*.jar app.jar

# Tạo user không có quyền root (bảo mật)
RUN addgroup -S spring && adduser -S spring -G spring
RUN chown -R spring:spring /app
USER spring:spring

EXPOSE 8080

# Health check endpoint
HEALTHCHECK --interval=30s --timeout=3s --start-period=60s --retries=3 \
    CMD wget --no-verbose --tries=1 --spider http://localhost:8080/actuator/health || exit 1

# JVM memory settings tối ưu cho VPS 3GB RAM
ENTRYPOINT ["java", "-Xms256m", "-Xmx512m", "-XX:+UseG1GC", "-jar", "-Dspring.profiles.active=prod", "app.jar"]
```

## 5.6.5. Cấu hình Docker Compose

File `docker-compose.prod.yml` định nghĩa toàn bộ stack ứng dụng với các tối ưu cho VPS RAM thấp:

```yaml
services:
    # PostgreSQL Database
    postgres:
        container_name: card-words-postgres
        image: postgres:16-alpine
        environment:
            - POSTGRES_USER=${POSTGRES_USER}
            - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
            - POSTGRES_DB=${POSTGRES_DB}
        ports:
            - '${POSTGRES_EXTERNAL_PORT}:5432'
        volumes:
            - postgres_data:/var/lib/postgresql/data
        networks:
            - card-words-network
        restart: unless-stopped
        deploy:
            resources:
                limits:
                    memory: 256M
                reservations:
                    memory: 128M
        # Tối ưu PostgreSQL cho RAM thấp
        command: >
            postgres
            -c shared_buffers=64MB
            -c effective_cache_size=128MB
            -c maintenance_work_mem=16MB
            -c work_mem=4MB
            -c max_connections=30

    # Redis Cache
    redis:
        image: redis:7-alpine
        container_name: card-words-redis
        ports:
            - '${REDIS_EXTERNAL_PORT}:6379'
        volumes:
            - redis_data:/data
        networks:
            - card-words-network
        command: redis-server --appendonly yes --maxmemory 64mb --maxmemory-policy allkeys-lru
        restart: unless-stopped
        deploy:
            resources:
                limits:
                    memory: 96M

    # Spring Boot API
    card-words-api:
        build:
            context: ./card-words
            dockerfile: Dockerfile
        container_name: card-words-api
        environment:
            - JAVA_OPTS=-Xms256m -Xmx384m -XX:+UseG1GC
            - SERVER_PORT=${SERVER_SPRING_PORT}
            - POSTGRES_HOST=${POSTGRES_HOST}
            # ... các biến môi trường khác
        ports:
            - '${SERVER_SPRING_PORT}:${SERVER_SPRING_PORT}'
        depends_on:
            postgres:
                condition: service_healthy
            redis:
                condition: service_healthy
        networks:
            - card-words-network
        restart: unless-stopped
        deploy:
            resources:
                limits:
                    memory: 512M

    # Python AI Service
    card-words-ai:
        build:
            context: ./card-words-ai
            dockerfile: Dockerfile
        container_name: card-words-ai
        environment:
            - DATABASE_URL=postgresql+asyncpg://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}
            - REDIS_URL=redis://${REDIS_HOST}:${REDIS_PORT}/${REDIS_AI_DB}
            - ACTIVE_MODEL_TYPE=${ACTIVE_MODEL_TYPE}
        ports:
            - '${SERVER_FLASH_PORT}:${SERVER_FLASH_PORT}'
        volumes:
            - ./card-words-ai/models:/app/models
        networks:
            - card-words-network
        restart: unless-stopped
        deploy:
            resources:
                limits:
                    memory: 384M

volumes:
    postgres_data:
    redis_data:

networks:
    card-words-network:
        driver: bridge
```

## 5.6.6. Triển khai hệ thống

### Bước 1: Build Docker images

```bash
cd /opt/card-words-services

# Build tất cả Docker images
docker compose -f docker-compose.prod.yml build

# Quá trình build mất khoảng 2-3 phút
```

### Bước 2: Khởi động containers

```bash
# Khởi động tất cả services ở chế độ background
docker compose -f docker-compose.prod.yml up -d

# Output:
# [+] Running 4/4
# ✔ Container card-words-postgres  Healthy
# ✔ Container card-words-redis     Healthy
# ✔ Container card-words-api       Started
# ✔ Container card-words-ai        Started
```

### Bước 3: Import database

```bash
# Import dữ liệu từ file SQL
docker exec -i card-words-postgres psql -U postgres -d card_words < railway_import.sql

# Kiểm tra dữ liệu đã import
docker exec -it card-words-postgres psql -U postgres -d card_words -c "SELECT COUNT(*) FROM users;"
```

### Bước 4: Kiểm tra trạng thái containers

```bash
# Xem danh sách containers đang chạy
docker ps

# Output:
# CONTAINER ID   IMAGE                    STATUS                    PORTS
# abc123         card-words-api           Up 2 minutes (healthy)    0.0.0.0:8080->8080/tcp
# def456         card-words-ai            Up 2 minutes (healthy)    0.0.0.0:8001->8001/tcp
# ghi789         postgres:16-alpine       Up 2 minutes (healthy)    0.0.0.0:5432->5432/tcp
# jkl012         redis:7-alpine           Up 2 minutes (healthy)    0.0.0.0:6379->6379/tcp
```

### Bước 5: Xem logs

```bash
# Xem logs của Spring Boot API
docker logs card-words-api --tail 50

# Xem logs của AI Service
docker logs card-words-ai --tail 50

# Theo dõi logs real-time
docker logs card-words-api -f
```

## 5.6.7. Kiểm tra hoạt động

### Health Check Endpoints

```bash
# Kiểm tra Spring Boot API
curl http://localhost:8080/actuator/health
# Response: {"status":"UP"}

# Kiểm tra AI Service
curl http://localhost:8001/health
# Response: {"status":"healthy"}

# Kiểm tra từ bên ngoài
curl http://103.9.77.220:8080/actuator/health
curl http://103.9.77.220:8001/health
```

### Kiểm tra kết nối database

```bash
# Kết nối vào PostgreSQL
docker exec -it card-words-postgres psql -U postgres -d card_words

# Chạy queries kiểm tra
SELECT COUNT(*) FROM users;
SELECT COUNT(*) FROM vocab;
\q
```

### Kiểm tra Redis cache

```bash
# Kết nối vào Redis
docker exec -it card-words-redis redis-cli

# Kiểm tra keys
KEYS *
PING
# Response: PONG
exit
```

## 5.6.8. Cấu hình Firewall

Để cho phép truy cập từ bên ngoài, cần mở các ports trên firewall của VPS:

```bash
# Mở port 8080 (Spring Boot API)
ufw allow 8080/tcp

# Mở port 8001 (AI Service)
ufw allow 8001/tcp

# Kiểm tra firewall status
ufw status
```

Hoặc cấu hình qua VinaHost Control Panel:

1. Truy cập vào VPS management panel
2. Chọn tab "Firewall"
3. Thêm rules:
    - Port 8080: TCP, Allow
    - Port 8001: TCP, Allow

## 5.6.9. Quản lý và bảo trì

### Restart services

```bash
# Restart một container cụ thể
docker restart card-words-api

# Restart tất cả services
docker compose -f docker-compose.prod.yml restart
```

### Stop services

```bash
# Stop tất cả services
docker compose -f docker-compose.prod.yml down

# Stop và xóa volumes (cẩn thận: mất dữ liệu)
docker compose -f docker-compose.prod.yml down -v
```

### Update code

```bash
# Pull code mới từ Git
cd /opt/card-words-services
git pull

# Rebuild và restart
cd card-words
mvn clean package -DskipTests
cd ..
docker compose -f docker-compose.prod.yml build card-words-api
docker restart card-words-api
```

### Backup database

```bash
# Backup database
docker exec card-words-postgres pg_dump -U postgres card_words > backup_$(date +%Y%m%d).sql

# Restore database
docker exec -i card-words-postgres psql -U postgres -d card_words < backup_20251129.sql
```

### Monitoring resources

```bash
# Xem resource usage của containers
docker stats

# Xem disk usage
docker system df

# Xem logs size
du -sh /var/lib/docker/containers/*
```

## 5.6.10. Kết quả triển khai

### Thông tin truy cập

-   **API Backend**: http://103.9.77.220:8080
-   **API Documentation (Swagger)**: http://103.9.77.220:8080/swagger-ui.html
-   **AI Service**: http://103.9.77.220:8001
-   **AI Service Docs**: http://103.9.77.220:8001/docs

### Tài nguyên sử dụng

| Service           | CPU     | RAM         | Disk        |
| ----------------- | ------- | ----------- | ----------- |
| PostgreSQL        | 0.5%    | 128 MB      | 500 MB      |
| Redis             | 0.2%    | 64 MB       | 50 MB       |
| Spring Boot API   | 2-5%    | 384 MB      | 200 MB      |
| Python AI Service | 1-3%    | 256 MB      | 150 MB      |
| **Tổng**          | **~8%** | **~832 MB** | **~900 MB** |

VPS còn dư khoảng 2.2 GB RAM cho hệ điều hành và các processes khác, đảm bảo hệ thống hoạt động ổn định.

### Thời gian khởi động

-   PostgreSQL: ~10 giây
-   Redis: ~5 giây
-   Spring Boot API: ~45 giây
-   Python AI Service: ~15 giây
-   **Tổng thời gian**: ~60 giây (từ lúc start đến khi tất cả services sẵn sàng)

## 5.6.11. Xử lý sự cố thường gặp

### Container không start

```bash
# Xem logs chi tiết
docker logs card-words-api --tail 100

# Kiểm tra container status
docker inspect card-words-api

# Restart container
docker restart card-words-api
```

### Out of memory

```bash
# Kiểm tra memory usage
free -h
docker stats --no-stream

# Giải pháp: Giảm memory limit trong docker-compose.prod.yml
# hoặc tăng swap memory
```

### Database connection failed

```bash
# Kiểm tra PostgreSQL đang chạy
docker ps | grep postgres

# Kiểm tra logs
docker logs card-words-postgres

# Test connection
docker exec -it card-words-postgres psql -U postgres -d card_words -c "SELECT 1;"
```

### Port already in use

```bash
# Kiểm tra port đang được sử dụng
netstat -tulpn | grep 8080

# Kill process đang dùng port
kill -9 <PID>

# Hoặc thay đổi port trong .env file
```

## 5.6.12. Kết luận

Hệ thống Card Words đã được triển khai thành công trên VPS với kiến trúc microservices sử dụng Docker. Việc sử dụng Docker Compose giúp quản lý các services dễ dàng, đảm bảo tính nhất quán giữa môi trường development và production.

Các tối ưu về memory và resource allocation đã được áp dụng để phù hợp với cấu hình VPS 3GB RAM, đảm bảo hệ thống hoạt động ổn định và có khả năng xử lý tải cao. Hệ thống đã sẵn sàng phục vụ người dùng với đầy đủ các tính năng học từ vựng, AI recommendation, và gamification.
